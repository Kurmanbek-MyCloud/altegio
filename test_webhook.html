<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –ø–ª–∞—Ç–µ–∂–µ–π Altegio</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #fafafa;
        }
        .test-section h3 {
            margin-top: 0;
            color: #555;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .result {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .webhook-url {
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            margin: 10px 0;
            word-break: break-all;
        }
        .payment-form {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .payment-form input, .payment-form select {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        .payment-form label {
            font-weight: bold;
            display: block;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üí∞ –¢–µ—Å—Ç –ø–ª–∞—Ç–µ–∂–µ–π Altegio</h1>
        
        <div class="test-section">
            <h3>üì° URL –≤–µ–±—Ö—É–∫–∞</h3>
            <p>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–æ—Ç URL –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –≤–∞—à–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Altegio:</p>
            <div class="webhook-url" id="webhookUrl">http://localhost:8000/main.php</div>
            <button onclick="copyWebhookUrl()">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å URL</button>
        </div>

        <div class="test-section">
            <h3>üí≥ –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞</h3>
            <p>–°–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂ —Å –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏:</p>
            <div class="payment-form">
                <label>–°—É–º–º–∞:</label>
                <input type="number" id="paymentAmount" value="1500" min="1" max="100000">
                
                <label>–í–∞–ª—é—Ç–∞:</label>
                <select id="paymentCurrency">
                    <option value="RUB">RUB</option>
                    <option value="USD">USD</option>
                    <option value="EUR">EUR</option>
                </select>
                
                <label>–ú–µ—Ç–æ–¥ –æ–ø–ª–∞—Ç—ã:</label>
                <select id="paymentMethod">
                    <option value="cash">–ù–∞–ª–∏—á–Ω—ã–µ</option>
                    <option value="card">–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞</option>
                    <option value="online">–û–Ω–ª–∞–π–Ω –æ–ø–ª–∞—Ç–∞</option>
                    <option value="transfer">–ë–∞–Ω–∫–æ–≤—Å–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥</option>
                </select>
                
                <label>–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                <input type="text" id="paymentDescription" value="–û–ø–ª–∞—Ç–∞ –∑–∞ —É—Å–ª—É–≥—É">
            </div>
            <button onclick="testTransactionCreated()">–°–æ–∑–¥–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é</button>
            <div id="transactionCreatedResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>‚úÖ –£—Å–ø–µ—à–Ω—ã–π –ø–ª–∞—Ç–µ–∂</h3>
            <p>–ò–º–∏—Ç–∏—Ä—É–µ—Ç —É—Å–ø–µ—à–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞</p>
            <button onclick="testPaymentReceived()">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å payment.received</button>
            <div id="paymentReceivedResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>‚ùå –ù–µ—É–¥–∞—á–Ω—ã–π –ø–ª–∞—Ç–µ–∂</h3>
            <p>–ò–º–∏—Ç–∏—Ä—É–µ—Ç –Ω–µ—É–¥–∞—á–Ω—É—é –ø–æ–ø—ã—Ç–∫—É –ø–ª–∞—Ç–µ–∂–∞</p>
            <button onclick="testPaymentFailed()">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å payment.failed</button>
            <div id="paymentFailedResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</h3>
            <p>–ò–º–∏—Ç–∏—Ä—É–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</p>
            <button onclick="testTransactionUpdated()">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å transaction.updated</button>
            <div id="transactionUpdatedResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>‚ùå –û—Ç–º–µ–Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</h3>
            <p>–ò–º–∏—Ç–∏—Ä—É–µ—Ç –æ—Ç–º–µ–Ω—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</p>
            <button onclick="testTransactionCancelled()">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å transaction.cancelled</button>
            <div id="transactionCancelledResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –≤–∏–∑–∏—Ç–∞</h3>
            <p>–ò–º–∏—Ç–∏—Ä—É–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –≤–∏–∑–∏—Ç–∞ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —Å–æ–∑–¥–∞–Ω–∏–µ–º –ø–ª–∞—Ç–µ–∂–∞</p>
            <button onclick="testVisitCompleted()">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å visit.completed</button>
            <div id="visitCompletedResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤</h3>
            <p>–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ñ–∞–π–ª—ã –ª–æ–≥–æ–≤ –ø–ª–∞—Ç–µ–∂–µ–π</p>
            <button onclick="checkLogs()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏</button>
            <button onclick="checkNotifications()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</button>
            <div id="logsResult" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è URL –≤–µ–±—Ö—É–∫–∞
        function copyWebhookUrl() {
            const url = document.getElementById('webhookUrl').textContent;
            navigator.clipboard.writeText(url).then(() => {
                alert('URL —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –≤–µ–±—Ö—É–∫–∞
        async function sendWebhook(eventType, data) {
            try {
                const response = await fetch('/main.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        event_type: eventType,
                        data: data
                    })
                });

                const result = await response.text();
                return {
                    status: response.status,
                    data: result
                };
            } catch (error) {
                return {
                    status: 'error',
                    data: error.message
                };
            }
        }

        // –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
        async function testTransactionCreated() {
            const resultDiv = document.getElementById('transactionCreatedResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞...';

            const amount = document.getElementById('paymentAmount').value;
            const currency = document.getElementById('paymentCurrency').value;
            const method = document.getElementById('paymentMethod').value;
            const description = document.getElementById('paymentDescription').value;

            const testData = {
                id: Math.floor(Math.random() * 10000) + 1000,
                client_id: Math.floor(Math.random() * 1000) + 100,
                amount: parseFloat(amount),
                currency: currency,
                payment_method: method,
                description: description,
                status: 'pending',
                created_at: new Date().toISOString()
            };

            const result = await sendWebhook('transaction.created', testData);
            
            resultDiv.className = result.status === 200 ? 'result success' : 'result error';
            resultDiv.textContent = `–°—Ç–∞—Ç—É—Å: ${result.status}\n\n–î–∞–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:\n${JSON.stringify(testData, null, 2)}\n\n–û—Ç–≤–µ—Ç:\n${result.data}`;
        }

        // –¢–µ—Å—Ç —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞
        async function testPaymentReceived() {
            const resultDiv = document.getElementById('paymentReceivedResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞...';

            const testData = {
                transaction_id: Math.floor(Math.random() * 10000) + 1000,
                client_id: Math.floor(Math.random() * 1000) + 100,
                amount: 1500,
                currency: 'RUB',
                payment_method: 'card',
                payment_date: new Date().toISOString(),
                receipt_url: 'https://example.com/receipt/123'
            };

            const result = await sendWebhook('payment.received', testData);
            
            resultDiv.className = result.status === 200 ? 'result success' : 'result error';
            resultDiv.textContent = `–°—Ç–∞—Ç—É—Å: ${result.status}\n\n–û—Ç–≤–µ—Ç:\n${result.data}`;
        }

        // –¢–µ—Å—Ç –Ω–µ—É–¥–∞—á–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞
        async function testPaymentFailed() {
            const resultDiv = document.getElementById('paymentFailedResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞...';

            const testData = {
                transaction_id: Math.floor(Math.random() * 10000) + 1000,
                client_id: Math.floor(Math.random() * 1000) + 100,
                amount: 1500,
                currency: 'RUB',
                payment_method: 'card',
                error_message: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –∫–∞—Ä—Ç–µ',
                error_code: 'INSUFFICIENT_FUNDS',
                failed_at: new Date().toISOString()
            };

            const result = await sendWebhook('payment.failed', testData);
            
            resultDiv.className = result.status === 200 ? 'result success' : 'result error';
            resultDiv.textContent = `–°—Ç–∞—Ç—É—Å: ${result.status}\n\n–û—Ç–≤–µ—Ç:\n${result.data}`;
        }

        // –¢–µ—Å—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
        async function testTransactionUpdated() {
            const resultDiv = document.getElementById('transactionUpdatedResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞...';

            const testData = {
                id: Math.floor(Math.random() * 10000) + 1000,
                client_id: Math.floor(Math.random() * 1000) + 100,
                amount: 2000,
                currency: 'RUB',
                payment_method: 'card',
                status: 'completed',
                updated_at: new Date().toISOString(),
                completed_at: new Date().toISOString()
            };

            const result = await sendWebhook('transaction.updated', testData);
            
            resultDiv.className = result.status === 200 ? 'result success' : 'result error';
            resultDiv.textContent = `–°—Ç–∞—Ç—É—Å: ${result.status}\n\n–û—Ç–≤–µ—Ç:\n${result.data}`;
        }

        // –¢–µ—Å—Ç –æ—Ç–º–µ–Ω—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
        async function testTransactionCancelled() {
            const resultDiv = document.getElementById('transactionCancelledResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞...';

            const testData = {
                id: Math.floor(Math.random() * 10000) + 1000,
                client_id: Math.floor(Math.random() * 1000) + 100,
                amount: 1500,
                currency: 'RUB',
                payment_method: 'card',
                status: 'cancelled',
                cancellation_reason: '–ö–ª–∏–µ–Ω—Ç –æ—Ç–º–µ–Ω–∏–ª –∑–∞–∫–∞–∑',
                cancelled_at: new Date().toISOString()
            };

            const result = await sendWebhook('transaction.cancelled', testData);
            
            resultDiv.className = result.status === 200 ? 'result success' : 'result error';
            resultDiv.textContent = `–°—Ç–∞—Ç—É—Å: ${result.status}\n\n–û—Ç–≤–µ—Ç:\n${result.data}`;
        }

        // –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤–∏–∑–∏—Ç–∞
        async function testVisitCompleted() {
            const resultDiv = document.getElementById('visitCompletedResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞...';

            const testData = {
                id: Math.floor(Math.random() * 10000) + 1000,
                appointment_id: Math.floor(Math.random() * 10000) + 1000,
                client_id: Math.floor(Math.random() * 1000) + 100,
                client_name: '–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤',
                service_id: 1,
                service_name: '–°—Ç—Ä–∏–∂–∫–∞',
                staff_id: 1,
                staff_name: '–ú–∞—Å—Ç–µ—Ä –ê–Ω–Ω–∞',
                datetime: new Date().toISOString(),
                duration: 60,
                status: 'completed',
                price: 1500,
                payment_method: 'card',
                payment_status: 'paid'
            };

            const result = await sendWebhook('visit.completed', testData);
            
            resultDiv.className = result.status === 200 ? 'result success' : 'result error';
            resultDiv.textContent = `–°—Ç–∞—Ç—É—Å: ${result.status}\n\n–û—Ç–≤–µ—Ç:\n${result.data}`;
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤
        async function checkLogs() {
            const resultDiv = document.getElementById('logsResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ–≤...';

            try {
                const response = await fetch('/webhook_log.txt');
                if (response.ok) {
                    const logs = await response.text();
                    resultDiv.className = 'result success';
                    resultDiv.textContent = logs || '–õ–æ–≥–∏ –ø—É—Å—Ç—ã';
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = '–§–∞–π–ª –ª–æ–≥–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω';
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ª–æ–≥–æ–≤: ' + error.message;
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        async function checkNotifications() {
            const resultDiv = document.getElementById('logsResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π...';

            try {
                const response = await fetch('/notifications.txt');
                if (response.ok) {
                    const notifications = await response.text();
                    resultDiv.className = 'result success';
                    resultDiv.textContent = notifications || '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç';
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = '–§–∞–π–ª —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω';
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π: ' + error.message;
            }
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ URL –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.onload = function() {
            const currentUrl = window.location.origin + '/main.php';
            document.getElementById('webhookUrl').textContent = currentUrl;
        };
    </script>
</body>
</html> 